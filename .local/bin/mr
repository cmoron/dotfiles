#!/usr/bin/env bash

# Minimalist script that launch git commands on every detected git repository
# existing in ROOT_PATH parameter.
# mr ~/dev status

set -o errexit
set -o nounset

ERR_CODE=1
GIT_BIN="git"
GIT_DIR=".git"

# Handles errors.
error() {
    >&2 echo "$1"
    exit $ERR_CODE
}

# Program entry point.
main() {

    if (( $# != 2 )); then
        error "2 parametere required: ROOT_PATH, GIT_CMD"
    fi

    local root_dir="$1"
    local git_cmd="$2"
    local current_dir="$PWD"

    if [[ ! -d "$root_dir" ]]; then
        error "$root_dir does not exists or is not a directory"
    fi

    while read -r project; do
        local repo
        repo=$(realpath "${project}"/..)
        cd "$repo"
        echo "************************************************"
        echo "$repo"
        echo "************************************************"
        $GIT_BIN $git_cmd

        cd "$current_dir"
    done < <(find "$root_dir" -type d -name $GIT_DIR)
}

main "$@"
